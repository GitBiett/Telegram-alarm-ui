<!doctype html>
<html lang="it">
<head>
  <link rel="stylesheet" href="css/style.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Allarme</title>

  <!-- Telegram Mini App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

</head>

<body>

<h1>ğŸ  Dashboard Allarme</h1>

<!-- STATO IMPIANTO -->
<div class="card">
  <div class="row">
    <div>
      <div class="title">Stato Impianto</div>
      <div class="muted">ModalitÃ  corrente</div>
    </div>
    <div id="alarmStatus" class="status off">DISATTIVO</div>
  </div>
</div>

<!-- PRESET -->
<div class="card">
  <div class="title">Preset</div>
  <button id="btn-attivo" class="btn-green" onclick="setAlarm('ATTIVO')">ATTIVA</button>
  <button id="btn-notte" class="btn-yellow" onclick="setAlarm('NOTTE')">NOTTE</button>
  <button id="btn-disattivo" class="btn-red" onclick="setAlarm('DISATTIVO')">DISATTIVA</button>
</div>

<!-- SENSORI -->
<div class="card">
  <div class="title">Sensori Porta</div>

  <div class="row sensor" data-sensor="ingresso">
    <div>
      <div>ğŸšª Ingresso</div>
      <div class="muted">Porta principale</div>
    </div>
    <div id="sensor-ingresso" class="status on">CHIUSA</div>
  </div>

  <div class="row sensor" data-sensor="cameretta" style="margin-top:10px;">
    <div>
      <div>ğŸšª Cameretta</div>
      <div class="muted">Porta interna</div>
    </div>
    <div id="sensor-cameretta" class="status on">CHIUSA</div>
  </div>
</div>


<!-- IP CAM -->
<div class="card">
  <div class="title">IP Cam</div>

  <div class="row" style="margin-top:10px;">
    <div>
      <div>Balcone Cucina</div>
      <div class="muted">Ultimo screenshot</div>
    </div>
    <div class="status off">â€”</div>
  </div>

  <div class="row" style="margin-top:10px;">
    <div>
      <div>Balcone Cameretta</div>
      <div class="muted">Ultimo screenshot</div>
    </div>
    <div class="status off">â€”</div>
  </div>

  <div class="placeholder">Screenshot non disponibile</div>
</div>

<!-- LUCI -->
<div class="card">
  <div class="title">Luci</div>

  <div class="row" style="margin-top:10px;">
    <div>
      <div>Cucina</div>
      <div class="muted">Luce principale</div>
    </div>
    <div id="lightCucina" class="toggle" onclick="toggleLight()"></div>
  </div>
</div>

<!-- STORICO -->
<div class="card">
  <div class="title">Storico Attivazioni</div>
  <div id="history" class="log">â€”</div>
</div>

<!-- ERRORI -->
<div class="card">
  <div class="title" style="color:#ef4444;">Errori</div>
  <div id="errors" class="log">Nessun errore rilevato</div>
</div>

<!-- LOG TECNICO -->
<div class="card">
  <div class="title">Log Tecnico</div>
  <div id="log" class="log">â€”</div>
</div>

<script>
  const tg = Telegram.WebApp;
  tg.expand();

  let lightOn = false;

  function log(msg) {
    const el = document.getElementById("log");
    el.innerText = (el.innerText === "â€”" ? "" : el.innerText + "\n") + msg;
  }

  function addHistory(msg) {
    const el = document.getElementById("history");
    el.innerText = (el.innerText === "â€”" ? "" : el.innerText + "\n") + msg;
  }

  function addError(msg) {
    const el = document.getElementById("errors");
    el.innerText = (el.innerText.includes("Nessun") ? "" : el.innerText + "\n") + msg;
  }


  function setAlarm(mode) {
    const statusEl = document.getElementById("alarmStatus");

    // reset pulsanti
    document.getElementById("btn-attivo").classList.remove("active");
    document.getElementById("btn-notte").classList.remove("active");
    document.getElementById("btn-disattivo").classList.remove("active");

    if (mode === "ATTIVO") {
      statusEl.innerText = "ATTIVO";
      statusEl.className = "status on";
      document.getElementById("btn-attivo").classList.add("active");
      tg.HapticFeedback?.notificationOccurred("success");
    }

    if (mode === "NOTTE") {
      statusEl.innerText = "NOTTE";
      statusEl.className = "status on";
      document.getElementById("btn-notte").classList.add("active");
      tg.HapticFeedback?.notificationOccurred("success");
    }

    if (mode === "DISATTIVO") {
      statusEl.innerText = "DISATTIVO";
      statusEl.className = "status off";
      document.getElementById("btn-disattivo").classList.add("active");
      tg.HapticFeedback?.notificationOccurred("warning");
    }

    addHistory("Allarme â†’ " + mode);
    log("Preset selezionato: " + mode);
  }

  function toggleLight() {
    const el = document.getElementById("lightCucina");
    lightOn = !lightOn;
    el.classList.toggle("on", lightOn);

    log("Luce cucina: " + (lightOn ? "ON" : "OFF"));
    tg.HapticFeedback?.impactOccurred("light");
  }



  function setDoorState(sensorId, isClosed) {
    const el = document.getElementById("sensor-" + sensorId);
    if (!el) return;

    if (isClosed) {
      el.innerText = "CHIUSA";
      el.className = "status on";
      log("Sensore " + sensorId + ": CHIUSA");
    } else {
      el.innerText = "APERTA";
      el.className = "status off";
      log("Sensore " + sensorId + ": APERTA");
      tg.HapticFeedback?.notificationOccurred("warning");
    }
  }

  // simulazione (puoi rimuoverla)
  // setTimeout(() => setDoorState("ingresso", false), 4000);
</script>

</body>
</html>
